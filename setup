#!/bin/bash

set -e
# set -v

export BBENV="$( cd "$( dirname "$0" )" && pwd )"

function header
{
    printf '\n\e[4;1m%s\e[0m\n' "$1"
}

# =============================================================================
# apt packages used by the rest of the script
# =============================================================================
header "SETUP PKG"
pkg update
pkg install \
    bat \
    binutils \
    build-essential \
    getconf \
    cmake \
    coreutils \
    curl \
    git \
    golang \
    grep \
    jq \
    neovim \
    nodejs \
    python3 \
    rust \
    termux-tools \
    which \
    zip unzip \
    zsh \
    ;

# =============================================================================
# setup XDG_CONFIG_HOME
# =============================================================================
header "SETUP CONFIG"
mkdir -p ${XDG_CONFIG_HOME:-$HOME/.config}
ln -sf $BBENV/xdg_config/* ${XDG_CONFIG_HOME:-$HOME/.config}/

# =============================================================================
# setup zsh
# =============================================================================
header "SETUP ZSH"
chsh -s "$(which zsh)" "$USER"

CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/zsh"
touch "$CONF_DIR/.zshrc.local"
ln -sf "$BBENV/.zshenv" "$HOME/.zshenv"

PLUGIN_DIR="$CONF_DIR/plugins"
curl -sS --create-dirs -L -o "$PLUGIN_DIR/zsh-history-substring-search.zsh" \
    https://raw.githubusercontent.com/zsh-users/zsh-history-substring-search/master/zsh-history-substring-search.zsh

# =============================================================================
# install other components using zsh so that they have paths from .zshenv
# =============================================================================
. "$HOME/.zshenv"
. ./setup-git.zsh
. ./setup-fonts.zsh
. ./setup-nodejs.zsh
. ./setup-rust.zsh
. ./setup-language-servers.zsh
. ./setup-neovim.zsh

# =============================================================================
# run post-install configurations
# =============================================================================
. ./configure-git.zsh
