#!/bin/bash

set -e

export BBENV="$(cd "$(dirname "$0")" && pwd)"

function header {
	printf '\n\e[4;1m%s\e[0m\n' "$1"
}

# =============================================================================
# apt packages used by the rest of the script
# =============================================================================
header "SETUP APT"
sudo add-apt-repository -y ppa:deadsnakes/ppa
sudo apt-get -y update
sudo apt-get -y install \
	build-essential \
	cmake \
	coreutils \
	curl \
	git \
	grep \
	jq \
	python3.13 \
	zip unzip \
	zsh \
	;

# =============================================================================
# Pipx
# =============================================================================
header "INSTALL PIPX"
# see https://github.com/pypa/pipx/issues/1481
sudo apt-get -y install pipx                   # installs pipx to /usr/local/bin
pipx ensurepath                                # adds ~/.local/bin to path
pipx install pipx                              # installs latest pipx to ~/.local/bin
sudo apt-get purge -y --autoremove pipx        # remove pipx via apt, and all extra files including autocomplete from /usr/local/bin
hash -r                                        # pick up the new path
sudo ~/.local/bin/pipx install pipx --global   # installs latest pipx version to /usr/local/bin because --global works.
pipx uninstall pipx                            # remove the local version
pipx ensurepath                                # make sure the ~/.local/bin is added to $PATH
sudo pipx ensurepath --global                  # make sure that /usr/local/bin is set to global install

# =============================================================================
# setup XDG_CONFIG_HOME
# =============================================================================
header "SETUP CONFIG"
mkdir -p ${XDG_CONFIG_HOME:-$HOME/.config}
ln -sf $BBENV/xdg_config/* ${XDG_CONFIG_HOME:-$HOME/.config}/

# =============================================================================
# setup zsh
# =============================================================================
header "SETUP ZSH"
sudo chsh -s "$(which zsh)" "$USER"

CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/zsh"
touch "$CONF_DIR/.zshrc.local"
ln -sf "$BBENV/.zshenv" "$HOME/.zshenv"

PLUGIN_DIR="$CONF_DIR/plugins"
curl -sS --create-dirs -L -o "$PLUGIN_DIR/zsh-history-substring-search.zsh" \
	https://raw.githubusercontent.com/zsh-users/zsh-history-substring-search/master/zsh-history-substring-search.zsh

# =============================================================================
# install other components using zsh so that they have paths from .zshenv
# =============================================================================
. "$HOME/.zshenv"
if dpkg -s gnome-shell >/dev/null 2>&1; then
	. ./setup-gnome.zsh
	. ./setup-fonts.zsh
fi
. ./setup-git.zsh
. ./setup-nodejs.zsh
. ./setup-go.zsh
. ./setup-rust.zsh
. ./setup-language-servers.zsh
. ./setup-neovim.zsh

# =============================================================================
# Misc tools
# =============================================================================
header "INSTALL MORE MISC TOOLS"
go install github.com/jesseduffield/lazygit@latest

# =============================================================================
# run post-install configurations
# =============================================================================
. ./configure-git.zsh
